{% extends "base.html" %}
{% block body %}
<div class="mb-6 flex items-center justify-between">
  <div>
    <h1 class="text-2xl font-semibold">Sources</h1>
    <p class="text-sm text-slate-500 mt-1">Pick an index/version to view ingested files and metadata. Filter, sort, export.</p>
  </div>
  <div class="flex items-center gap-2">
    <button id="btn-health" class="rounded-lg bg-emerald-600 text-white px-3 py-1.5 text-sm hover:bg-emerald-500">Health</button>
  </div>
</div>

<section class="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
  <!-- Controls -->
  <div class="grid md:grid-cols-4 gap-4 items-end">
    <div>
      <label class="text-sm font-medium">Index</label>
      <select id="index-select" class="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2"></select>
    </div>
    <div>
      <label class="text-sm font-medium">Version (optional)</label>
      <select id="version-select" class="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2">
        <option value="">(latest)</option>
      </select>
    </div>
    <div>
      <label class="text-sm font-medium">Filter</label>
      <input id="filter-input" placeholder="filename, sha, or date…" class="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2"/>
    </div>
    <div class="flex gap-2">
      <button id="load-btn" class="w-full rounded-xl bg-brand-600 hover:bg-brand-700 text-white px-4 py-2 font-medium">Load Sources</button>
      <button id="export-btn" class="rounded-xl border px-4 py-2 border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800">Export CSV</button>
    </div>
  </div>

  <!-- Summary -->
  <div id="summary-cards" class="grid sm:grid-cols-2 lg:grid-cols-4 gap-3 mt-6"></div>

  <!-- Table -->
  <div class="mt-4">
    <div class="flex items-center justify-between mb-2">
      <div id="summary" class="text-sm text-slate-500"></div>
      <div class="flex items-center gap-3">
        <label class="text-xs text-slate-500">Page size
          <select id="page-size" class="ml-2 rounded-md border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-2 py-1 text-xs">
            <option>10</option><option>25</option><option>50</option><option>100</option>
          </select>
        </label>
        <div class="flex items-center gap-1">
          <button id="prev-page" class="rounded-md border px-2 py-1 text-xs border-slate-300 dark:border-slate-700">Prev</button>
          <span id="page-info" class="text-xs text-slate-500 px-1">—</span>
          <button id="next-page" class="rounded-md border px-2 py-1 text-xs border-slate-300 dark:border-slate-700">Next</button>
        </div>
      </div>
    </div>
    <div class="overflow-auto">
      <table id="src-table" class="min-w-full text-sm"></table>
      <div id="table-skeleton" class="space-y-2 hidden">
        <div class="animate-pulse h-8 rounded bg-slate-200/60 dark:bg-slate-700/40"></div>
        <div class="animate-pulse h-8 rounded bg-slate-200/60 dark:bg-slate-700/40"></div>
        <div class="animate-pulse h-8 rounded bg-slate-200/60 dark:bg-slate-700/40"></div>
        <div class="animate-pulse h-8 rounded bg-slate-200/60 dark:bg-slate-700/40"></div>
      </div>
    </div>
  </div>
</section>

<!-- Toast -->
<div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden rounded-xl bg-slate-900 text-white px-4 py-2 shadow-lg"></div>

<script>
/* ===== Global error trap so silent JS errors don’t kill the page ===== */
window.addEventListener('error', (e) => {
  const t = document.getElementById('toast');
  if (t){ t.textContent = 'JS error: ' + (e?.message || e); t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 3000); }
  console.error('Global error:', e);
});

/* ---------- Canonical index/version helpers ---------- */
const IndexLab = {
  _cache: { idx: null, idx_exp: 0, ver: new Map() },

  async fetchIndexes(force=false){
    const now = Date.now();
    if (!force && this._cache.idx && this._cache.idx_exp > now) return this._cache.idx;
    const r = await fetch('/api/indexes'); const j = await r.json();
    const arr = Array.isArray(j.indexes) ? j.indexes : [];
    this._cache.idx = arr; this._cache.idx_exp = now + 30_000;
    return arr;
  },

  async populateIndexSelect(selectEl, {value=null, includePlaceholder=true}={}){
    const sel = (typeof selectEl === 'string') ? document.querySelector(selectEl) : selectEl;
    if (!sel) return;
    const items = await this.fetchIndexes();
    sel.innerHTML = '';
    if (includePlaceholder) {
      const opt = document.createElement('option'); opt.value=''; opt.textContent='(choose index)'; sel.appendChild(opt);
    }
    for (const it of items){
      const o = document.createElement('option');
      o.value = it.index_name;
      o.textContent = it.index_name + (it.latest_version ? ` · v${it.latest_version}` : '');
      sel.appendChild(o);
    }
    if (value && [...sel.options].some(o=>o.value===value)) sel.value = value;
    return sel.value;
  },

  async fetchVersions(indexName){
    if (!indexName) return [];
    const cached = this._cache.ver.get(indexName);
    if (cached) return cached;
    const r = await fetch(`/api/versioning/${encodeURIComponent(indexName)}`);
    const j = await r.json();
    const arr = Array.isArray(j.versions) ? j.versions : [];
    this._cache.ver.set(indexName, arr);
    return arr;
  },

  async populateVersionSelect(selectEl, indexName, {value=null}={}){
    const sel = (typeof selectEl === 'string') ? document.querySelector(selectEl) : selectEl;
    if (!sel) return;
    const versions = await this.fetchVersions(indexName);
    const prev = sel.value;
    sel.innerHTML = '<option value="">(latest)</option>';
    for (const v of versions){
      const o = document.createElement('option');
      o.value = v.version;
      const when = v.created_at ? ` — ${new Date(v.created_at).toISOString().replace('T',' ').slice(0,16)}Z` : '';
      o.textContent = `v${v.version}${when}`;
      sel.appendChild(o);
    }
    const desired = value || prev;
    if (desired && [...sel.options].some(o=>o.value===desired)) sel.value = desired;
  }
};

/* ---------- utils ---------- */
const qs=(s,el=document)=>el.querySelector(s);
const qsa=(s,el=document)=>[...el.querySelectorAll(s)];
const toast=(m)=>{const t=qs('#toast'); t.textContent=m; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),1500);};
const save=(k,v)=>localStorage.setItem(k, JSON.stringify(v));
const load=(k,d)=>{ try{return JSON.parse(localStorage.getItem(k)) ?? d;} catch {return d;} };
const fmtDate=(s)=> s ? new Date(s).toISOString().replace('T',' ').slice(0,19)+' UTC' : '';
function esc(x){ return (x??'').toString().replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

/* ---------- state ---------- */
let RAW_ROWS = [];
let VIEW_ROWS = [];
let SORT = { key: 'file', dir: 'asc' };
let PAGE = 1;
let PAGE_SIZE = 10;
let CURRENT_INDEX = '';
let CURRENT_VERSION = '';

/* ---------- init ---------- */
(async function init(){
  try{
    // deep link (?index=foo&version=YYYYMMDD-HHMMSS&autoload=1)
    const params = new URLSearchParams(location.search);
    const idxFromUrl = params.get('index');
    const verFromUrl = params.get('version');
    const autoload = params.get('autoload') === '1';

    // populate Index select
    const sel = qs('#index-select');
    await IndexLab.populateIndexSelect(sel, { value: idxFromUrl || load('indexlab_sources_index', null), includePlaceholder: false });
    CURRENT_INDEX = sel.value || '';

    // populate Version select for the chosen index
    await IndexLab.populateVersionSelect('#version-select', CURRENT_INDEX, { value: verFromUrl || load('indexlab_sources_version', '') });
    CURRENT_VERSION = qs('#version-select').value || '';

    // events
    qs('#load-btn').addEventListener('click', loadSources);
    qs('#filter-input').addEventListener('input', () => { PAGE=1; applyFilterSortPaginate(); renderTable(); });
    qs('#page-size').addEventListener('change', (e)=> { PAGE_SIZE = Number(e.target.value||10); PAGE=1; renderTable(); save('indexlab_sources_psize', PAGE_SIZE); });
    PAGE_SIZE = Number(load('indexlab_sources_psize', 10));
    qs('#page-size').value = PAGE_SIZE;
    qs('#prev-page').addEventListener('click', ()=>{ if (PAGE>1){ PAGE--; renderTable(); }});
    qs('#next-page').addEventListener('click', ()=>{ const max = Math.max(1, Math.ceil(VIEW_ROWS.length / PAGE_SIZE)); if (PAGE<max){ PAGE++; renderTable(); }});
    qs('#export-btn').addEventListener('click', exportCSV);
    qs('#btn-health').addEventListener('click', pingHealth);

    // on index change, refresh versions and reload
    sel.addEventListener('change', async ()=>{
      CURRENT_INDEX = sel.value || '';
      await IndexLab.populateVersionSelect('#version-select', CURRENT_INDEX);
      CURRENT_VERSION = qs('#version-select').value || '';
      loadSources();
    });

    // on version change, reload
    qs('#version-select').addEventListener('change', ()=>{
      CURRENT_VERSION = qs('#version-select').value || '';
      loadSources();
    });

    // hotkey: Ctrl/Cmd + Enter loads
    document.addEventListener('keydown', (e)=> {
      if (!(e.ctrlKey || e.metaKey) || e.key !== 'Enter') return;
      loadSources();
    });

    // auto-load
    if (autoload || CURRENT_INDEX) loadSources();
  }catch(e){
    console.error('init error', e);
    toast('Init error: ' + (e?.message || e));
  }
})();

/* ---------- fetchers ---------- */
async function loadSources(){
  const name = qs('#index-select').value;
  const version = qs('#version-select').value || '';
  if(!name){ toast('Pick an index'); return; }
  CURRENT_INDEX = name; CURRENT_VERSION = version;
  save('indexlab_sources_index', name);
  save('indexlab_sources_version', version);

  // update URL for shareability
  const p = new URLSearchParams({ index:name, autoload:'1' });
  if (version) p.set('version', version);
  history.replaceState(null, '', `?${p.toString()}`);

  // skeleton
  toggleSkeleton(true);
  qs('#src-table').innerHTML = '';
  qs('#summary-cards').innerHTML = '';
  qs('#summary').textContent = 'Loading…';

  try{
    const url = `/api/sources/${encodeURIComponent(name)}${version ? `?version=${encodeURIComponent(version)}` : ''}`;
    const r = await fetch(url);
    const txt = await r.text();
    if (!r.ok) {
      qs('#summary').textContent = `Error ${r.status}: ${txt}`;
      RAW_ROWS = []; VIEW_ROWS = []; renderTable();
      return;
    }
    const data = JSON.parse(txt);

    renderSummaryCards(data, version);
    const built = data.created_at ?? '—';
    qs('#summary').textContent =
      `index=${data.index_name || name} ` +
      (version ? `• version=${version} ` : '') +
      `• chunks=${data.count ?? '—'} • model=${data.model ?? '—'} • backend=${data.backend ?? '—'} • created_at=${built}`;

    RAW_ROWS = normalizeSources(data.sources ?? data.manifest?.sources ?? null);
    PAGE = 1;
    SORT = { key: 'file', dir: 'asc' };
    applyFilterSortPaginate();
    renderTable();
  }catch(e){
    console.error('loadSources error', e);
    qs('#summary').textContent = 'Failed to load sources (JS).';
    qs('#src-table').innerHTML = '';
  }finally{
    toggleSkeleton(false);
  }
}

/* ---------- normalization ---------- */
function normalizeSources(sources){
  if (!sources) return [];
  if (Array.isArray(sources)) {
    return sources.map(row => ({
      file:     row.file || row.path || row.origin_path || row.title || '',
      rows:     row.rows ?? row.count ?? null,
      sha256:   row.sha256 || row.hash || '',
      added_at: row.added_at || row.ingested_at || row.created_at || '',
      url:      row.url || row.origin_url || ''
    }));
  }
  if (typeof sources === 'object') {
    return Object.entries(sources).map(([file, meta]) => ({
      file,
      rows:     meta?.rows ?? meta?.count ?? null,
      sha256:   meta?.sha256 || meta?.hash || '',
      added_at: meta?.added_at || meta?.ingested_at || meta?.created_at || '',
      url:      meta?.url || meta?.origin_url || ''
    }));
  }
  return [];
}

/* ---------- summary cards ---------- */
function renderSummaryCards(data, version){
  const box = (label, value, sub='') => `
    <div class="rounded-xl border border-slate-200 dark:border-slate-700 p-4 bg-white dark:bg-slate-900/60">
      <div class="text-xs text-slate-500">${label}</div>
      <div class="text-xl font-semibold mt-0.5">${esc(value ?? '—')}</div>
      ${sub ? `<div class="text-[11px] text-slate-500 mt-1">${esc(sub)}</div>` : ''}
    </div>`;
  const cards = [
    box('Index', data.index_name || CURRENT_INDEX, version ? `v${version}` : '(latest)'),
    box('Chunks', data.count ?? '—'),
    box('Model', data.model ?? '—', data.dim ? `${data.dim} dims` : ''),
    box('Backend', data.backend ?? '—', data.created_at ? fmtDate(data.created_at) : '')
  ];
  qs('#summary-cards').innerHTML = cards.join('');
}

/* ---------- table rendering ---------- */
function toggleSkeleton(on){
  qs('#table-skeleton').classList.toggle('hidden', !on);
}

function headerCell(key, label){
  const is = SORT.key === key, dir = is ? (SORT.dir==='asc' ? '▲' : '▼') : '⇵';
  return `<th data-key="${key}" class="sorter sticky top-0 bg-white dark:bg-slate-800 z-10 text-left px-2 py-2 text-xs font-semibold text-slate-600 dark:text-slate-300 border-b dark:border-slate-700 cursor-pointer select-none">
    ${label} <span class="opacity-70">${dir}</span>
  </th>`;
}

function renderTable(){
  const tbl = qs('#src-table');
  if (!VIEW_ROWS.length){
    tbl.innerHTML = `<tbody><tr><td class="px-2 py-3 text-slate-500">No source metadata recorded.</td></tr></tbody>`;
    qs('#page-info').textContent = '0 / 0';
    return;
  }

  const start = (PAGE-1)*PAGE_SIZE;
  const pageRows = VIEW_ROWS.slice(start, start + PAGE_SIZE);

  const thead = `
    <thead class="text-xs">
      <tr>
        ${headerCell('file','File')}
        ${headerCell('rows','Rows')}
        ${headerCell('sha256','SHA-256')}
        ${headerCell('added_at','Added at (UTC)')}
        <th class="sticky top-0 bg-white dark:bg-slate-800 z-10 text-left px-2 py-2 text-xs font-semibold text-slate-600 dark:text-slate-300 border-b dark:border-slate-700">Actions</th>
      </tr>
    </thead>`;

  const tbody = `
    <tbody>
      ${pageRows.map(r => `
        <tr class="odd:bg-slate-50 dark:odd:bg-slate-800/40">
          <td class="px-2 py-2"><div class="font-medium">${esc(r.file)}</div></td>
          <td class="px-2 py-2">${r.rows ?? ''}</td>
          <td class="px-2 py-2 font-mono text-xs">
            ${r.sha256 ? `<span title="${esc(r.sha256)}">${esc((r.sha256||'').slice(0, 12))}…</span>` : ''}
          </td>
          <td class="px-2 py-2">${esc(r.added_at || '')}</td>
          <td class="px-2 py-2">
            <div class="flex items-center gap-2 text-xs">
              ${r.url ? `<a href="${esc(r.url)}" target="_blank" rel="noopener" class="border rounded px-2 py-1">View</a>` : ''}
              ${r.sha256 ? `<button class="btn-copy border rounded px-2 py-1" data-text="${esc(r.sha256)}">Copy SHA</button>` : ''}
              <button class="btn-copy border rounded px-2 py-1" data-text="${esc(r.file)}">Copy path</button>
            </div>
          </td>
        </tr>
      `).join('')}
    </tbody>`;

  tbl.innerHTML = thead + tbody;

  // sorting handlers
  qsa('.sorter', tbl).forEach(th => th.addEventListener('click', () => {
    const key = th.dataset.key;
    if (!key) return;
    SORT = { key, dir: (SORT.key===key && SORT.dir==='asc') ? 'desc' : 'asc' };
    PAGE = 1;
    applyFilterSortPaginate();
    renderTable();
  }));

  // copy handlers
  qsa('.btn-copy', tbl).forEach(b => b.addEventListener('click', async () => {
    try { await navigator.clipboard.writeText(b.dataset.text || ''); toast('Copied'); } catch { toast('Copy failed'); }
  }));

  // page info
  const max = Math.max(1, Math.ceil(VIEW_ROWS.length / PAGE_SIZE));
  qs('#page-info').textContent = `${PAGE} / ${max}`;
}

/* ---------- filtering, sorting ---------- */
function applyFilterSortPaginate(){
  const q = (qs('#filter-input').value || '').toLowerCase().trim();
  VIEW_ROWS = RAW_ROWS.filter(r => {
    if (!q) return true;
    return [r.file, r.sha256, r.added_at, r.rows?.toString() || ''].some(v => (v||'').toString().toLowerCase().includes(q));
  });
  const key = SORT.key, dir = SORT.dir;
  VIEW_ROWS.sort((a,b) => {
    const av=a[key], bv=b[key];
    if (key==='rows') { const na=Number(av)||0, nb=Number(bv)||0; return dir==='asc' ? na-nb : nb-na; }
    const sa=(av??'').toString(), sb=(bv??'').toString();
    return dir==='asc' ? sa.localeCompare(sb) : sb.localeCompare(sa);
  });
}

/* ---------- export ---------- */
function exportCSV(){
  if (!VIEW_ROWS.length){ toast('Nothing to export'); return; }
  const header = ['index','version','file','rows','sha256','added_at'];
  const lines = [header.join(',')].concat(VIEW_ROWS.map(r => [
    csvCell(CURRENT_INDEX), csvCell(CURRENT_VERSION || '(latest)'), csvCell(r.file), csvCell(r.rows), csvCell(r.sha256), csvCell(r.added_at)
  ].join(',')));
  const blob = new Blob([lines.join('\n')], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `sources_${CURRENT_INDEX}${CURRENT_VERSION?`_v${CURRENT_VERSION}`:''}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
function csvCell(v){
  const s = (v??'').toString();
  if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}

/* ---------- misc ---------- */
async function pingHealth(){
  try{ const r = await fetch('/api/health'); toast(r.ok ? 'API healthy' : 'Health failed'); }
  catch { toast('API unreachable'); }
}
</script>
{% endblock %}
